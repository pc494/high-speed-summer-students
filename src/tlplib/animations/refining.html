<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Secondary Steelmaking</title>

		<!-- Greensock library  -->
		<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Draggable.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MotionPathPlugin.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Flip.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/EaselPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/PixiPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/TextPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollToPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Observer.min.js"></script> -->

		<script> gsap.registerPlugin(MotionPathPlugin)  </script>

		<link rel="stylesheet" href="titlecard.css"/>
		<link rel="stylesheet" href="blastFurnace.css"/>

		<script>
		// hide and show CC licence words
			function showTxt() {
				document.getElementById("para").style.visibility = 'visible';
			}  // end showTxt

			function hideTxt() {
				document.getElementById("para").style.visibility = 'hidden';
			}  // end hideTxt

			// page navigation
			function gotoPage(p) {
				// replace next fn gEBCN as fails in IE<9
				var x = document.getElementsByClassName("payj");
				var len = x.length;
				for (var i=1; i<(len+1); i++) {
					var ppp = eval('p'+i);
					document.getElementById('p'+i).style.display = 'none';
					if (i == p) {
						document.getElementById('p'+i).style.display = 'block';
					}
				}
			}

			// sets the dimensions of kanvas and positions the bottom logos
			function setAnimDimensions(w,h)  {
				//w = animation width
				//h = animation height
				document.getElementById("kanvas").style.height = String(h) + "px";
				document.getElementById("kanvas").style.width = String(w) + "px";
				document.getElementById("kanvas").style.margin = "0px auto";
				document.getElementById("kanvas").style.border = "2px solid blue";
				// position footers
				var divcc = document.getElementById("cc");
				var divpara = document.getElementById("para");
				divcc.style.position = 'absolute';
				divpara.style.position = 'absolute';
				divcc.style.top = (h - 40) + "px";
				divpara.style.top = (h - 85) + "px";
			}
		</script>

		<style>

			#container {
				position:relative;
			}
			#kanvas {
				position:relative;
			}

			/* cc information banner & pop-up */
			#cc {
				position: absolute;
				width:100%;
				/*background-color:#cc0000;  */
			}

			#para {
				position: absolute;
				padding:0px;
				font-family:Arial;
				font-weight: bold;
				font-size: 11px;
				color:blue;
				border-style: solid;
				border-color: #000000;
				border-width:1px;
				visibility: hidden;
				z-index: 200;
				background-color: white;
			}

			/* DOiTPoMS buttons */
			.dbutton {
				background-color: pink;
				cursor: pointer;
				height: 25px;
				margin: 5px;
				background-position: bottom;
				display: inline-block;  /* allows on sameline */
			}

			.dbutton:hover {
				background-position: center;
			}

			#back, #back2, #back3, #back4, #back5, #back6, #back7 {
				width: 79px;
				background-image: url('../../../images/back.png');
			}

			#next, #next2, #next3, #next4, #next5, #next6, #next7 {
				width: 75px;
				background-image: url('../../../images/next.png');
			}

			#restart, #restart2, #restart3,  #restart5, #restart6, #restart7 {
				width: 99px;
				background-image: url('../../../images/restart.png');
			}
			#reset {
				width: 84px;
				background-image: url('../../../images/reset.png');
			}
			#start {
				width: 76px;
				background-image: url('../../../images/start.png');
			}
			#pause {
				width: 83px;
				background-image: url('../../../images/pause.png');
			}
			#continue {
				width: 118px;
				background-image: url('../../../images/continue.png');
			}

			.nav {
				position:absolute;
				left:170px;
				top:420px;
				width:300px;
				text-align: center;
			}

			/* page id */
			/* CAHNGE THIS!!! */
			#p1 {
				display:block;
			}
			#p2, #p3, #p4, #p5, #p6, #p7, #p8, #p9   {
				display:none;
			}

			/*  Other */
			* {
				font-family: sans-serif;
			}

			#caption {
				position: absolute;
				top: 365px;
				height: 45px;
				left: 20px;
				width: 600px;
				margin: auto auto;
				text-align: center;
				vertical-align: middle;
				text-overflow: hidden;
			}
		</style>

	</head>

	<body>
		<div id="container">
			<div id="kanvas">

				<!-- DoITPoMS  and CC logos -->
				<div id="para">
					Re-use of this resource is governed by a Creative Commons Attribution-<br />
					Noncommercial-Share Alike 2.0 Licence UK: England & Wales<br />
					http://creativecommons.org/licenses/by-nc-sa/2.0/uk/
				</div>
				<!-- end para -->
				<div id="cc" >
					<img src = "../../../images/by-nc-sa.svg" alt="creative commons" onMouseOver="showTxt()" onMouseOut="hideTxt()" height=40 width=120 />
					<img src = "../../../images/roo.png" alt="DoITPoMS logo" height=40 width=180 style="float:right"; />
				</div>
				<!-- end cc -->

				<script>
					setAnimDimensions(640,480);
				</script>

				<!--  new page starts here    -->
				<div class="payj" id="p1">
					<div>
						pointer and mask steelInFurnace <br/>
					</div>

					<p id="titlecard">Secondary Steelmaking</p>
					<div class="nav" style="top:280px">
						<p class="dbutton" id="start" onClick="gotoPage(2)"></p >
					</div>

				</div>
				<!-- end payj - p1 -->

				<!--  new page starts here    -->
				<div class="payj" id="p2">

					<p class="dbutton" id="restart" onclick="restart()" style="position:absolute"></p>


					<svg width="640" height="350">

						<g id="vacuum">
							<path class="vacuum clickable_parts" id="vacuum_chamber" style="fill:none; stroke:darkgrey; stroke-width:10px;" d="M300,90 l0,-20 l-240,0 l0,260 l240,0 l0,-200"></path>
							<path class="vacuum" id="vacuum_gasline" style="fill:none; stroke:lightgrey; stroke-width:3px; stroke-linecap:round; filter:blur(1px);" d="M260,120 C280,90 320,140 340,90"></path>
						</g>

						<g id="ladle">

							<clipPath id="furnace_guts">
								<path class="LMF" style="fill:white" d="M120,120 l0,10 l-25,25 l0,110 l30,30 l70,0 l30,-30 l0,-110 l-25,-25 l0,-10"></path>
							</clipPath>

							<clipPath id="steel_level">
								<path class="steel" style="transform:translateY(2px)" d="M70,210 C80,215 120,212 140,210 S180,205 200,205 S240,205 250,210 l0,120 l-180,0 Z"></path>
							</clipPath>

							<g class="content" clip-path="url(#furnace_guts)">
								<path class="steel" style="fill:gold; stroke:darkorange; stroke-width:4px; stroke-linejoin:round" d="M70,210 C80,215 120,212 140,210 S180,205 200,205 S240,205 250,210 l0,120 l-180,0 Z"></path>
								<g class="B"></g>
								<circle class="LMF LMF_adder_content" clip-path="url(#steel_level)" style="fill:white; stroke:none; filter:blur(5px)" cx="135" cy="230" r="0"></circle>
							</g>

							<g class ="clickable_parts" id="LMF_wall">
								<path class="LMF" id="LMF_body" style="fill:darkgrey; stroke:none" d="M110,120 l-30,30 l0,120 l40,40 l80,0 l40,-40 l0,-120 l-30,-30 l-10,0 l0,10 l25,25 l0,110 l-30,30 l-70,0 l-30,-30 l0,-110 l25,-25 l0,-10 l-10,0"></path>
								<path class="LMF" id="LMF_lining" style="fill:none; stroke:dimgrey; stroke-width:8px" d="M120,120 l0,10 l-25,25 l0,110 l30,30 l70,0 l30,-30 l0,-110 l-25,-25 l0,-10"></path>
							</g>
							
							<path class="LMF nozzle clickable_parts" id="LMF_nozzle" style="fill:none; stroke:lightblue; stroke-width:8px" d="M180,320 l0,-30"></path>

							<line class="LMF clickable_parts" id="LMF_adder" style="fill:dimgrey; stroke:dimgrey; stroke-width:8px;" x1="135" y1="80" x2="135" y2="230"></line>
							<line class="LMF" id="LMF_adder_tube" style="fill:dimgrey; stroke:white; stroke-width:2px;" x1="135" y1="80" x2="135" y2="80"></line>

							<g class="clickable_parts" id="pointer">
								<circle class="lens" style="fill:white; stroke:white; stroke-width:7px; filter:blur(2px)"></circle>
								<circle class="lens" style="fill:mediumspringgreen; stroke:none;"></circle>
							</g>

							<path class="LMF" id="steel_in_furnace" style="fill:white; opacity:0; stroke:none; transform:scale(0.8); transform-origin:160px 225px;" d="M95,215 l0,50 l30,30 l70,0 l30,-30 l0,-50 Z"></path>
							
						</g>

						<g id="microscope">
							<clipPath id="microscope_FOV">
								<circle class="lens"></circle>
							</clipPath>
							<g id="directions">
								<circle style="fill:none; stroke:white; stroke-width:40px; filter:blur(5px)" cx="470" cy="180", r="120"></circle>
								<path class="direction" id="up" d="M470,50 l-15,15 l30,0 Z"></path>
								<path class="direction" id="left" d="M340,180 l15,15 l0,-30 Z"></path>
								<path class="direction" id="down" d="M470,310 l-15,-15 l30,0 Z"></path>
								<path class="direction" id="right" d="M600,180 l-15,15 l0,-30 Z"></path>
							</g>
							<text id="identifier" style="text-anchor:middle; font-weight:bold" x="470" y="330"></text>
						</g>
						
					</svg>

					<button id="remove_button" style="position:absolute; top:335px; left:420px; width:100px">Remove</button>

					<style>
						.impurity, .inclusion, .alloy, .direction, .clickable_parts {
							cursor: pointer;
						} 

						/* .clickable_parts:hover, .direction:hover {
							filter: drop-shadow(0px 0px 5px mediumspringgreen)
						} */

						.direction {
							fill: white;
							stroke:mediumspringgreen;
							stroke-width: 4px;
							stroke-linejoin: round;
						}

						.bubble{
							fill: white;
							stroke: white;
							stroke-width: 0.5px;
							fill-opacity: 0.4;
						}

						path {
							fill: none;
							stroke: red;
						}
					</style>

					<p id="caption"></p>

					<div class="nav">
						<p class="dbutton" id="back" onclick="back()" style="visibility:hidden"></p>
					</div>

					<script>
						
						// keeper
						var always = gsap.timeline({repeat:-1, defaults:{ease:"none"}})
						var brownian = gsap.timeline({repeat:-1, defaults:{ease:"none"}})
						const fakeClickSVG = new MouseEvent("click", {view:window, bubbles:true, cancelable:true})
						const fakeHoverSVG = new MouseEvent("mouseover", {view:window, bubbles:true, cancelable:true})

						// set points
						const currFocus = {x:160,y:250}
						const viewbox = {x:470, y:180, r:120}
						const scale = 30
						const furnaceSize = {width:120, height:90, top:200, left:100}
						const R = 0.2 //impurity particle base radius (in px)

						// microscope
						const bigDolly = document.querySelector(".content").cloneNode(true)
						bigDolly.setAttribute("clip-path", "url(#microscope_FOV)")
						document.getElementById("microscope").prepend(bigDolly)
						updateScope(0,0)
						// magic masking
						const steelInFurnace = document.getElementById("steel_in_furnace")
						document.getElementById("ladle").addEventListener("mouseover", function(e){steelInFurnace.style.visibility="hidden"})
						document.getElementById("ladle").addEventListener("mouseout", function(e){steelInFurnace.style.visibility="visible"})

						document.querySelectorAll("svg #microscope #directions .direction").forEach((btn,i) => {
							btn.addEventListener("click", function(e){
								var dx = - ( (-1)**i - 1)*(i-2)*(viewbox.r/scale)*0.7
								var dy = ( (-1)**i + 1)*(i-1)*(viewbox.r/scale)*0.7
								updateScope(dx, dy)																	
							})
						})

						function updateScope(dx,dy){
							var lensMask = document.querySelectorAll("circle.lens")
							var x = Number(currFocus.x) + dx
							var y = Number(currFocus.y) + dy
							var Transform = `scale(${scale}) translate(${- x + (viewbox.x/scale)}px, ${- y + (viewbox.y/scale)}px)`
							gsap.to(bigDolly, 0.3, {ease:"none", transformOrigin:"50% 100%", scale:scale, x: (viewbox.x-160)-scale*(x-160), y:(viewbox.y-330)-scale*(y-330)})
							gsap.to(lensMask, 0.3, {ease:"none", attr:{cx:x, cy:y, r:viewbox.r/scale}})
							currFocus.x = x
							currFocus.y = y
							var dirButtons = document.querySelectorAll("svg #microscope #directions .direction")
							dirButtons.forEach(btn => btn.style.visibility = "visible")
							var svgRect = document.querySelector("svg").getBoundingClientRect()
							var X = x + svgRect.left
							var Y = y + svgRect.top
							if (document.elementFromPoint(X,Y) != document.getElementById("steel_in_furnace")){
								console.log(X,Y)
								if (y<210){ dirButtons[0].style.visibility = "hidden" }
								if (x<130){ dirButtons[1].style.visibility = "hidden" }
								if (y>260){ dirButtons[2].style.visibility = "hidden" }
								if (x>210){ dirButtons[3].style.visibility = "hidden" }
							}
						}

						// inside the steel
						function bubblies(N, durr=2, bg=false){
							var Bubbles = new Array()
							var r0 = 4
							var bubbleGroup = document.createElementNS("http://www.w3.org/2000/svg", "g")
							bubbleGroup.classList.add("bubblies")
							for (let n=0; n<N; n++){
								var init = Math.random()
								var bubble = document.createElementNS("http://www.w3.org/2000/svg", "circle")
								var motionPath = document.createElementNS("http://www.w3.org/2000/svg", "path")
								bubble.classList.add("bubble")
								bubble.setAttribute("cx", 180)
								bubble.setAttribute("cy", 295)
								bubble.setAttribute("r", 0)
								motionPath.setAttribute("d", `M180,295 C${220 - 120*Math.random()},${280-70*Math.random()}, ${220 - 120*Math.random()},${280-70*Math.random()}, ${220 - 120*Math.random()},210`)
								bubbleGroup.appendChild(bubble)
								Bubbles[n] = {MP: motionPath, I: init}
							}

							document.querySelectorAll("svg .content .B")[0].appendChild(bubbleGroup)
							var dollyBubbyG = bubbleGroup.cloneNode(true)
							document.querySelectorAll("svg .content .B")[1].appendChild(dollyBubbyG)

							function bubbleFloat(){
								[bubbleGroup, dollyBubbyG].forEach(g => {
									Bubbles.forEach((el, n) => {
										var bubble = g.querySelectorAll(".bubble")[n]
										var pathTotalLength = el.MP.getTotalLength()
										var bubbleLoc = el.MP.getPointAtLength(pathTotalLength*2*Math.min(0.5, Math.max(phantom.progress-0.5*n/N, 0)))
										bubble.setAttribute("cx", bubbleLoc.x)
										bubble.setAttribute("cy", bubbleLoc.y)
										bubble.setAttribute("r", r0*(el.I)*(370-bubbleLoc.y)/80)
										bubble.style.opacity = (0.4+0.6*el.I)*(bubbleLoc.y-210)/80*(1-phantom.progress**(n))
										if (bg == true){
											bubble.style.opacity = (0.4*el.I)*(bubbleLoc.y-210)/80*(1-phantom.progress**(n))
										}
									})
								})
							}

							function bubblePopper(){
								bubbleGroup.remove()
								dollyBubbyG.remove()
							}
							var phantom = {progress:0}
							gsap.to(phantom, durr, {progress:1, onUpdate:bubbleFloat, onComplete:bubblePopper})
						}

						function addThroughAdders(timeline, colour){
							document.querySelectorAll(".LMF_adder_content, #LMF_adder_tube").forEach(elem => {
								elem.style.visibility = "visible"
								elem.style.opacity = 1
							})
							timeline.set("#LMF_adder_tube", {stroke:colour}).set(".LMF_adder_content", {fill:colour})
							.to("#LMF_adder_tube", 1, {attr:{y2:230}})
							.to(".LMF_adder_content", 2, {attr:{r:100}, opacity:0})
							.to("#LMF_adder_tube", 1, {opacity:0}, 1)
							.set("#LMF_adder_tube", {attr:{y2:80}, opacity:1}).set(".LMF_adder_content", {attr:{r:0}, opacity:1})
						}

						function addAlloyingElem(){

							var group = document.querySelector(".Alloy")
							var alloying = gsap.timeline({defaults:{ease:"none"}})

							alloying.set(group, {opacity:0, visibility:"visible"})
							addThroughAdders(alloying, impuritiesLib["Alloy"].colour)
							alloying.to(group, 1.5, {opacity:1}, ">-1.5")

							updateParticleGroup(group)
							document.getElementById("alloying_addition").disabled = "true"

						}

						function refineToGas(name, colour) {

							var group = document.querySelector("."+name)
							var rtg = gsap.timeline({defaults:{ease:"none"}})

							// hide remove button
							removeButton.disabled = "none"

							// add removal reagent
							rtg.call(bubblies, [200, 7])

							// react + become bubbles
							group.querySelectorAll(".impurity").forEach((p,index) => {
								var bubble = p.cloneNode()
								bubble.classList = ["inclusion"]
								if (Math.random() < 0.6){
									bubble.classList.add("float")
								}
								bubble.setAttribute("r", 1)
								bubble.setAttribute("fill", colour)
								bubble.setAttribute("stroke", colour)
								bubble.setAttribute("stroke-width", "0.05px")
								bubble.style.opacity = 0
								group.appendChild(bubble)
							})

							function removeImpurity() {
								group.querySelectorAll(".impurity").forEach(p => p.remove())
							}
							rtg.to("."+name+" .inclusion", 1, {opacity:1, attr:{r:R}, onComplete:removeImpurity}, 1)

							// go up and leave & check if all impurities are removed
							function removeImpurities() {
								group.querySelectorAll(".float").forEach(p => p.remove())
								group.classList = ["Inclusions"]
								updateParticleGroup(group)
								if (document.querySelectorAll(".impurity").length == 0){
									gsap.set("#vacuum_chamber", {visibility:"visible"})
									gsap.to("#vacuum_chamber", 1, {delay:0.1, opacity: 1})
								}
							}
							rtg.to("."+name+" .inclusion", 1, {strokeOpacity:0.7, fillOpacity:0.4}, ">")
							rtg.to("."+name+" .float", 2, {attr:{cy:190}, opacity:0, onComplete:removeImpurities})
							
						}

						function refineToSlag(name, colour) {

							var group = document.querySelector("."+name)
							var rts = gsap.timeline({defaults:{ease:"none"}})

							// hide remove button
							removeButton.disabled = "none"

							// add removal reagent
							addThroughAdders(rts, colour)

							// react + become inclusions
							group.querySelectorAll(".impurity").forEach((p,index) => {
								var inclusion = p.cloneNode()
								inclusion.classList = ["inclusion"]
								if (Math.random() < 0.8){
									inclusion.classList.add("float")
								}
								inclusion.setAttribute("r", 1)
								inclusion.setAttribute("fill", colour)
								inclusion.setAttribute("stroke", colour)
								inclusion.setAttribute("stroke-width", "0.05px")
								inclusion.style.opacity = 0
								group.appendChild(inclusion)
							})
							
							function removeImpurity() {
								group.querySelectorAll(".impurity").forEach(p => p.remove())
							}
							rts.to("."+name+" .inclusion", 1, {opacity:1, attr:{r:2*R}, onComplete:removeImpurity}, ">-0.5")
							
							function removeImpurities() {
								group.querySelectorAll(".float").forEach(p => p.remove())
								group.classList = ["Inclusions"]
								updateParticleGroup(group)
								if (document.querySelectorAll(".impurity").length == 0){
									gsap.set("#vacuum_chamber", {visibility:"visible"})
									gsap.to("#vacuum_chamber", 1, {delay:0.1, opacity: 1})
								}
							}
							rts.to("."+name+" .float", 2, {attr:{cy:190}, opacity:0, onComplete:removeImpurities})
							
						}
						
						function vacuumDegas(){

							removeButton.disabled = "none"
							document.getElementById("caption").innerHTML = "Vacuum degassing is typically carried out as the final refining step. <br/> The ladle is placed inside a vacuum chamber, and the low-pressure environment helps remove gases bubbles through."

							var vdg = gsap.timeline({defaults:{ease:"none"}})

							// gas motionpath + bubbles
							var gasline = document.getElementById("vacuum_gasline")
							var totalLength = gasline.getTotalLength()
							phantomFlow = {progress:0}
							function update(){
								gasline.style.strokeDasharray = phantomFlow.progress*totalLength+" "+totalLength
							}
							vdg.set(gasline, {visibility:"visible", opacity:1})
							vdg.to(phantomFlow, 2, {repeat:5, progress:1, onUpdate:update, onStart:bubblies, onStartParams:[200,5], onRepeat:bubblies, onRepeatParams:[200,5]}, 0)
						
							// inclusions go up with bubbles 
							vdg.to(".inclusion", 10, {attr:{cy:190}, onComplete:removeIncl}, 2)

							// remove inclusions 
							function removeIncl(){document.querySelectorAll(".Inclusions").forEach(g => g.remove())}
							
							vdg.set(gasline, {visibility:"hidden", opacity:0})
							vdg.set("#vacuum_chamber", {visibility:"hidden", opacity:0})
						}
						// impurities
						const impuritiesLib = {

							"Alloy": {
								colour: "darkturquoise",
								type: "dissolved",
								size: 1,
								caption: "Alloying additions are added to achieve desired properties in the final steel.",
								crit(){return false}
							},

							"Inclusions": {
								colour: "steelblue",
								size: 2,
								caption: "Inclusions are different phases which exist in the mixture (intermetallics, salts, etc.); <br/> these can be solid, liquid, or gaseous. <br/> They typically float and segregate to the slag phase, or float up with bubbles.",
								crit(){return document.getElementById("vacuum_chamber").checkVisibility({opacityProperty:true})},
								removal() {vacuumDegas()}
							},

							"Oxygen": {
								colour: "aliceblue",
								size: 1,
								caption: "Dissolved oxygen react with deoxidisers (Si, Al, etc.), forming inclusions (SiO&#x2082;, Al&#x2082;O&#x2083;, etc.) which prefers the slag phase.",
								crit(){return true},
								removal() {refineToSlag("Oxygen", "lightgrey")}
							},

							"Sulfur": {
								colour: "yellow",
								size: 1,
								caption: "Common desulfurising fluxes include CaO, which reacts with S in steel to form CaS and O&#x2082;. <br/> CaS preferentially partition to the slag phase.",
								crit(){return true},
								removal() {refineToSlag("Sulfur", "white")}
							},

							"Carbon": {
								colour: "dimgrey",
								size: 1,
								caption: "Dissolved C is oxidised by O&#x2082;, <br/> the resulting CO&#x2082; then bubbles through the steel.",
								crit(){return true},
								removal() {refineToGas("Carbon", "aliceblue")}
							},

						}

						const gridSize = {w:4, h:4}
						function generateImpurities(){
							Object.entries(impuritiesLib).forEach(([key,impurity]) => {
							
								// add imupurity group
								var group = document.createElementNS("http://www.w3.org/2000/svg", "g")
								group.classList.add(key)

								if (key == "Inclusions"){
									var label = "inclusion"
								} else if (key == "Alloy"){
									var label = "alloy"
								} else {
									var label = "impurity"
									group.classList.add("Impurities")
								}
								
								// grid of particles 
								for (let m=0; m<furnaceSize.width/(impurity.size*gridSize.w); m++){
									for (let n=0; n<furnaceSize.height/(impurity.size*gridSize.h); n++){

										// make particle
										var p = document.createElementNS("http://www.w3.org/2000/svg", "circle")
										var pLoc = {
											x: furnaceSize.left + (m + Math.random())*(impurity.size*gridSize.w),
											y: furnaceSize.top + (n + Math.random())*(impurity.size*gridSize.h)
										}
										p.classList.add(label)
										p.setAttribute("cx", pLoc.x)
										p.setAttribute("cy", pLoc.y)
										p.setAttribute("r", impurity.size*R)
										p.setAttribute("fill", impurity.colour)
										p.setAttribute("stroke", impurity.colour)
										p.setAttribute("stroke-width", 3*R)
										p.setAttribute("stroke-opacity", 0)

										// add p to group 
										group.appendChild(p)
									}
								}
								// hide alloying additions 
								if (key =="Alloy"){ group.style.visibility = "hidden"}

								// add group to bigDolly
								document.querySelectorAll("svg .content")[1].appendChild(group)
								group.setAttribute("clip-path", "url(#steel_level)")

								// make particles move 
								brownian.to(group, 1, {x:2*(0.5 - Math.random()), y:2*(0.5 - Math.random())}, 0)
								brownian.to(group, 1, {x:2*(0.5 - Math.random()), y:2*(0.5 - Math.random())}, 0.5)
								brownian.to(group, 1, {x:2*(0.5 - Math.random()), y:2*(0.5 - Math.random())}, 1)
								brownian.to(group, 0.5, {x:0, y:0}, 1.5)

								// make the particles clickable
								updateParticleGroup(group)
							})
						}

						// add event listeners to group of inclusions/impurities
						var removeButton = document.getElementById("remove_button")
						function updateParticleGroup(group){
							var groupName = group.classList[0]
							var Impurity = impuritiesLib[groupName]
							group.querySelectorAll("circle").forEach(p => {
								p.addEventListener("click", function(e){
									
									document.getElementById("identifier").innerHTML = groupName
									document.getElementById("caption").innerHTML = Impurity.caption
									
									if (Impurity.crit()){
										removeButton.disabled = false
										removeButton.onclick = Impurity.removal
									} else {
										removeButton.disabled = true
									}
								})
							})
						}						

						// furnace parts
						// ladle
						document.getElementById("LMF_wall").addEventListener("click", function(e) {
							document.getElementById("caption").innerHTML = "Secondary steelmaking typically takes place in containers lined with high-alumina or magnesia based-materials. <br/> This known as a <strong>ladle</strong>, in which <strong>ladle metallurgy</strong> processes occur. "
						})

						// nozzle
						document.getElementById("LMF_nozzle").addEventListener("click", function(e){
							document.getElementById("caption").innerHTML = "<strong>O&#x2082; and Ar</strong> are injected at high flow rate to stir the mixture. <br/> Amount of O&#x2082; is adjusted to decarburise the steel without oxidising it. <br/> Modern ladles also use electromagnetic stirring."
						})

						// adder
						document.getElementById("LMF_adder").addEventListener("click", function(e){
							document.getElementById("identifier").innerHTML = "Select impurity particle"
							document.getElementById("remove_button").disabled = true
							document.getElementById("caption").innerHTML = "Alloying additions and refining reagents are added to the mixture. <br/> This is either done manually or through <strong>injection lances</strong>. <br/> <button id='alloying_addition'>Add alloying additions</button>"
							var alloyButton = document.getElementById("alloying_addition")
							if (document.querySelector(".Alloy").checkVisibility({opacityProperty:true, visibilityProperty:true})){
								alloyButton.disabled = true
							} else {
								alloyButton.disabled = false
								alloyButton.onclick = addAlloyingElem
							}
						})

						// focus point
						var pointer = document.querySelectorAll("#pointer circle")[1]
						var lensCover = document.querySelector("#microscope .content")
						var dirButtons = document.querySelectorAll(".direction")
						var pointerTwinkle = gsap.timeline()
						pointerTwinkle.to(pointer, 0.5, {filter:"blur(5px)"}, 0).to([lensCover], 0.5, {filter:"blur(0.3px)"}, 0).to([pointer, lensCover], 1, {filter:"blur(0px)"}, 0.5)
						pointerTwinkle.set(".direction", {filter:"drop-shadow(0px 0px 5px mediumspringgreen)"}, 0).set(".direction", {filter:"none"}, 1)
						document.getElementById("pointer").addEventListener("click", function(e){
							pointerTwinkle.restart()
						})

						// vacuum chamber
						document.getElementById("vacuum_chamber").addEventListener("click", function(e){
							document.querySelector(".inclusion").dispatchEvent(fakeClickSVG)
						})

						// steel wobble and gas inlet bubble
						always.to(".steel", 0.7, {attr:{d:"M70,210 C80,215 120,208 140,200 S180,220 200,220 S240,195 250,210 l0,120 l-180,0 Z"}},0)
						always.to(".steel", 0.5, {attr:{d:"M70,210 C80,212 120,218 140,195 S180,180 200,210 S240,215 250,210 l0,120 l-180,0 Z"}},">")
						always.to(".steel", 0.3, {attr:{d:"M70,210 C80,205 120,200 140,215 S180,215 200,200 S240,180 250,210 l0,120 l-180,0 Z"}},">")
						always.to(".steel", 0.5, {attr:{d:"M70,210 C80,215 120,212 140,210 S180,205 200,205 S240,205 250,210 l0,120 l-180,0 Z"}},">")					
						always.add(gsap.delayedCall(0, bubblies, ["70", 8, true]))

						// clickable parts style things
						document.querySelectorAll(".clickable_parts, .direction").forEach(el => {
							el.addEventListener("mouseover", function(e){
								el.style.filter = "drop-shadow(0px 0px 5px mediumspringgreen)"
							})
							el.addEventListener("mouseout", function(e){
								el.style.filter = "none"
							})
						})
					
						// restart 
						function restart(){	
							document.querySelectorAll(".Alloy, .Impurities, .Inclusions").forEach(g => g.remove())
							brownian = gsap.timeline({repeat:-1, defaults:{ease:"none"}})
							document.querySelectorAll("#vacuum_chamber, .LMF_adder_content, #LMF_adder_tube, #vacuum_gasline").forEach(elem => {
								elem.style.visibility = "hidden"
								elem.style.opacity = 0
							})
							generateImpurities()
							document.getElementById("caption").innerHTML = "<em>Click on different parts of the furnace to start</em>"
							document.getElementById("identifier").innerHTML = "Select impurity particle"
							document.getElementById("remove_button").disabled = true
							gotoPage(1)
						}

						restart()
					</script>

				</div>
				<!-- end payj - p2 -->

			</div> <!-- kanvas -->

		</div> <!-- container -->

	</body>
</html>