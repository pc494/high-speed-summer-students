<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Scrap Processing</title>

		<!-- Greensock library  -->
		<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Draggable.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/MotionPathPlugin.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Flip.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/EaselPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/PixiPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/TextPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollToPlugin.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script> -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Observer.min.js"></script> -->


		<link rel="stylesheet" href="titlecard.css"/>

		<script>
		// hide and show CC licence words
			function showTxt() {   
				document.getElementById("para").style.visibility = 'visible';
			}  // end showTxt

			function hideTxt() { 
				document.getElementById("para").style.visibility = 'hidden';
			}  // end hideTxt

			// page navigation
			function gotoPage(p) {
				// replace next fn gEBCN as fails in IE<9
				var x = document.getElementsByClassName("payj");
				var len = x.length;
				for (var i=1; i<(len+1); i++) {
					var ppp = eval('p'+i);
					document.getElementById('p'+i).style.display = 'none';
					if (i == p) {
						document.getElementById('p'+i).style.display = 'block';
					}
				}	
			}

			// sets the dimensions of kanvas and positions the bottom logos			
			function setAnimDimensions(w,h)  {
				//w = animation width
				//h = animation height
				document.getElementById("kanvas").style.height = String(h) + "px";
				document.getElementById("kanvas").style.width = String(w) + "px";
				document.getElementById("kanvas").style.margin = "0px auto";
				document.getElementById("kanvas").style.border = "2px solid blue";
				// position footers
				var divcc = document.getElementById("cc");
				var divpara = document.getElementById("para");
				divcc.style.position = 'absolute';
				divpara.style.position = 'absolute';
				divcc.style.top = (h - 40) + "px";
				divpara.style.top = (h - 85) + "px";						
			}
		</script>

		<style>

			#container {
				position:relative;
			}
			#kanvas { 
				position:relative;
			}

			/* cc information banner & pop-up */
			#cc {
				position: absolute; 
				width:100%; 
				/*background-color:#cc0000;  */
			}

			#para {
				position: absolute;  
				padding:0px;
				font-family:Arial;
				font-weight: bold;
				font-size: 11px;
				color:blue; 
				border-style: solid;
				border-color: #000000;
				border-width:1px;
				visibility: hidden;
				z-index: 200;
				background-color: white;
			}

			/* DOiTPoMS buttons */
			.dbutton {
				background-color: pink;
				cursor: pointer;
				height: 25px;
				margin: 5px;
				background-position: bottom;
				display: inline-block;  /* allows on sameline */
			}

			.dbutton:hover {
				background-position: center; 
			}

			#back, #back2, #back3, #back4, #back5, #back6, #back7 {
				width: 79px;
				background-image: url('../../../images/back.png');
			}

			#next, #next2, #next3, #next4, #next5, #next6, #next7 {
				width: 75px;
				background-image: url('../../../images/next.png');
			}

			#restart, #restart2, #restart3,  #restart5, #restart6, #restart7 {
				width: 99px;
				background-image: url('../../../images/restart.png');
			}
			#reset {
				width: 84px;
				background-image: url('../../../images/reset.png');
			}
			#start { 
				width: 76px;
				background-image: url('../../../images/start.png');
			}
			#pause {
				width: 83px;
				background-image: url('../../../images/pause.png');
			}
			#continue {
				width: 118px;
				background-image: url('../../../images/continue.png');
			}

			.nav {
				position:absolute;
				left:170px;
				top:420px;
				width:300px;
				text-align: center;
			}

			/* page id */
			#p1 {
				display:block;				
			}
			#p2, #p3, #p4, #p5, #p6, #p7, #p8, #p9   {
				display:none;				
			}

			/*  Other */
			* {
				font-family: sans-serif;
			}

			#caption {
				position: absolute;
				top: 365px;
				height: 45px;
				left: 20px;
				width: 600px;
				margin: auto auto;
				text-align: center;
				vertical-align: middle;
				text-overflow: hidden;
			}
		</style>

	</head>

	<body>
		<div id="container"> 
			<div id="kanvas"> 

				<!-- DoITPoMS  and CC logos -->
				<div id="para"> 
					Re-use of this resource is governed by a Creative Commons Attribution-<br />
					Noncommercial-Share Alike 2.0 Licence UK: England & Wales<br />
					http://creativecommons.org/licenses/by-nc-sa/2.0/uk/ 
				</div>
				<!-- end para -->
				<div id="cc" > 
					<img src = "../../../images/by-nc-sa.svg" alt="creative commons" onMouseOver="showTxt()" onMouseOut="hideTxt()" height=40 width=120 /> 
					<img src = "../../../images/roo.png" alt="DoITPoMS logo" height=40 width=180 style="float:right"; /> 
				</div>
				<!-- end cc -->

				<script>
					setAnimDimensions(640,480);
				</script>

				<!--  new page starts here    -->
				<div class="payj" id="p1"> 

					<p id="titlecard"> Separation, Sorting, and Pre-treatment </p>
					<div class="nav" style="top:280px"> 
						<p class="dbutton" id="start" onClick="gotoPage(2)"></p >
					</div>

				</div>
				<!-- end payj - p1 -->

				<!--  new page starts here    -->
				<div class="payj" id="p2"> 

					<p class="dbutton" id="restart" onclick="restart()" style="position:absolute"></p>

					<style> 
						#p2>div, #p2>*>div {
							position:absolute;
						}

						p {
							margin: 0
						}

						.bar {
							z-index: 100;
						}

						.bar .tab {
							display: block;
							border: grey 2px solid;
						}

						.bar.vertical .tab {
							width: 30px;
							height: 30px;
							border-bottom-left-radius: 5px;
							border-top-left-radius: 5px;
						}

						.bar.horizontal .tab {
							padding: 6px 5px;
                            width: max-content;
							border-top-right-radius: 5px;
							border-top-left-radius: 5px;
                            overflow: hidden;
						}

                        /* #bin_display, #process_display {
                            font-size: small;
                        } */

                        #process_display .page {
                            position:absolute;
                            top: 0;
                            left: 0;
                            height: 100%;
                            width: 100%
                        }

                        #process_display .page>div {
                            padding: 5px;
                            position: relative
                        }

                        #process_display .explanation {
                            position: absolute;
                        }


                        .page, .explanation {
                            display: none;
                        }

					</style>

					<div id="title" style="top:30px; left:20px; width:600px; background-color: rgb(250, 244, 244)">
						<strong style="font-size: x-large">Scrap Yard</strong>
						<button onclick="popup()" style="text-align: right;"><em>Instructions</em></button>
					</div>

					<div style="top:70px; left:20px; height:360px; width:210px">

						<div class="bar vertical" id="bin_bar" style="display:grid; background-color: rgb(240,240,250);">
							<div class="tab bin_tab">
                                <svg>
                                    <rect class="bin_bg" x="0" y="0" width="30" height="30"></rect>
                                    <path class="bin_pile" d="M7,12 Q15,3 23,12 Z"></path>
                                    <path class="bin_body" d="M5,12 l3,10 l14,0 l3,-10 Z"></path>
                                </svg>
                            </div>
						</div>

						<div id="bin_display" style="top:0px; left:30px; border: grey 2px solid; background-color: aliceblue;">

							<div id="bin_picture" style="height:180px; width:180px; background-color: rgb(251, 240, 255);">
								<svg class="bin_content"></svg>
								<svg></svg>
								<svg></svg>
							</div>

							<div id="bin_infobar" style="height:180px; width:180px; background-color: rgb(240, 255, 241);">
								<div id="bin_mass">Mass</div>
								<div id="bin_content">Content</div>
								<div id="bin_notes">Notes</div>
							</div>

						</div>

					</div>

					<div id="process" style="top:70px; left:240px; height:360px; width:210px">

						<div class="bar horizontal" id="process_bar" style="display:grid; grid-auto-flow:column; background-color: rgb(240,240,250);">
							<div class="tab separation">Separation</div> 
                            <!-- shredding, manual disassembling -->
							<div class="tab sorting">Sorting</div>
                            <!-- magnetic, eddy current, sensor-based (colour, NIR, XRT), manual -->
							<div class="tab pretreatment">Pre-treatment</div>
							<div class="tab delivery">Delivery</div>
                            <!-- 
                            Incineration
                            Plastic, metal, battery
                            ferrous scrap, copper, Al
                            steels 
                            -->
							<div class="tab summary">Summary</div>
                            <!-- Recovery rate, cost, revenue, profit -->
						</div>

						<div id="process_display" style="top:30px; height:330px; width:380px; border: grey 2px solid; background-color: aliceblue;">
                            
                            <div class="page instructions">
                                <p>
                                    15 tonnes of scrap <br/>
                                </p>
                            </div>
                            <div class="page menu separation">
                                <div>
                                    <button class="menu_button shredding">Shredding</button>
									<button class="menu_button granulating">Granulator</button>
                                </div>
                                <div>
                                    <p class="explanation shredding">
                                        Shredders help break down pieces of scrap, ideally into sufficiently small particles such that each only contain one type of material (fully liberated). <br/>
                                        Different materials also have different responses to the applied force. 
                                    </p>
									<p class="explanation granulating">
										The granulator further breaks down small pieces of scrap into fine granules.
									</p> 
                                </div>
                            </div>

                            <div class="page menu sorting" id="sorting_menu">
                                <div>
                                    <p>Electromagnetic</p>
                                    <button class="menu_button magnetic">Magnetic</button>
                                    <button class="menu_button eddy">Eddy current</button>
                                </div>
                                <div>
                                    <p>Sensor-based</p>
                                    <button class="menu_button colour">Colour</button>
                                    <button class="menu_button NIR">NIR</button>
                                    <button class="menu_button XRF">XRF</button>
                                </div>
                                <div>
                                    <p>Other</p>
                                    <button class="menu_button manual">Manual</button>
                                    <button class="menu_button size">Size</button>
                                </div>

                                <div>
                                    <p class="explanation magnetic">
                                        Sorting by magnetic properties <br/>
                                        Magnetic particles are separated out from the rest.
                                    </p>
                                    <p class="explanation eddy">
                                        A changing magnetic field is applied to induce eddy currents in the particles. <br/>
                                        Conductive and non-conductive particles are separated.
                                    </p>
                                    <p class="explanation colour">
                                        Radiation in the visible spectrum is detected (commonly RGB). <br/>
                                        Used to sort particles by their appearance.
                                    </p>
                                    <p class="explanation NIR">
                                        Radiation in the near infra-red (NIR) region. <br/>
                                        Used to sort different polymers. 
                                    </p>
                                    <p class="explanation XRF">
                                        X-ray fluorescence (XRF), characteristic to specific element. <br/>
                                        Used to identify elements present in local region, effective for heavier elements. 
                                    </p>
                                </div>
                                
                            </div>

                            <div class="page menu delivery" id="delivery_menu">

                            </div>

                            <div class="page summary">

                            </div>

                            <button id="execute" style="position:absolute; right:5px; bottom:5px" onclick="execute()">Go</button>
                        </div>

					</div>

                    <script>

                        // materials library
                        const Stainless = {
                            tree: ["mix", "metal", "steel", "stainless steel"],
                            density: 8,
                            colour: "cadetblue"
                        }
                        const Plain = {
                            tree: ["mix", "metal", "steel", "low alloy steel"],
                            density: 8,
                            colour: "steelblue"
                        }
                        const Iron = {
                            tree: ["mix", "metal", "steel", "cast iron"],
                            density: 8,
                            colour: "darkslategrey"
                        }
                        const Copper = {
                            tree: ["mix", "metal", "copper", "copper"],
                            density: 9,
                            colour: "chocolate"
                        }
                        const Aluminium = {
                            tree: ["mix", "metal", "aluminium", "aluminium"],
                            density: 3,
                            colour: "blueviolet"
                        }
                        const Tin = {
                            tree: ["mix", "metal", "tin", "tin"],
                            density: 7,
                            colour: "silver"
                        }
                        const Plastic = {
                            tree: ["mix", "plastic", "plastic", "plastic"],
                            density: 1,
                            colour: "red"
                        }
                        const Wood = {
                            tree: ["mix", "wood", "wood", "wood"],
                            density: 0.5, 
                            colour: "darkolivegreen"
                        }
						const Paint = {
                            tree: ["mix", "", "", ""], 
                            density: 0, 
                            colour: "deeppink"
                        }
                        const Other = {
                            tree: ["mix", "", "", ""], 
                            density: 0, 
                            colour: "none"
                        }

                        // particles 
                        function Particle(material, contaminant, frac, size, mass) {

							this.name = material.tree[3]
                            this.material = material
                            this.density = Number(material.density)
                            this.size = Number(size)
                            this.mass = Number(mass)
                            this.contaminant = contaminant
                            this.frac = frac

							if (contaminant == Other){
								this.outer = material
							} else {
								this.outer = contaminant
							}
							
                        }
						
						function checkPartName(part) {
							if (part.contaminant == Paint){
								part.name = part.name + " (painted)"
							} else if (part.contaminant == Tin){
								part.name = part.name + " (tin-plated)"
							} else if (part.contaminant == Plastic){
								part.name = part.name + " (plastic-wrapped)"
							} else if (part.contaminant == Copper){
								part.name = part.name + " (copper-wrapped)"
							}
							return part.name
						}
                        
                        const stainless = new Particle(Stainless, Other, 0.1, 1000, 5)
                        const plain = new Particle(Plain, Paint, 0.5, 1000, 3)
                        const iron = new Particle(Iron, Paint, 0.5, 1000, 3)
                        const motor = new Particle(Iron, Copper, 10, 10, 0.02)
                        const cans = new Particle(Plain, Tin, 5, 100, 0.3)
                        const wire = new Particle(Copper, Plastic, 10, 100, 0.08)
                        const Cu = new Particle(Copper, Other, 0.1, 1000, 0.6)
                        const Al = new Particle(Aluminium, Other, 0.1, 1000, 1)
                        const plastic = new Particle(Plastic, Other, 0.1, 100, 1)
                        const wood = new Particle(Wood, Other, 0.1, 1000, 1)

                        // bins
                        function Bin(particles) {

							this.particles = []
                            const log = {material: [], contaminant: [], frac: [], size: []}
							var masses = []
							particles.forEach( p => {
								var isNew = true
								log_loop: for(let j=0; j<log.material.length; j++){
									if (Object.keys(log).every(key => log[key][j] == p[key])){
										masses[j] += p.mass
										isNew = false
										break log_loop
									}
								}
								if (isNew){
									Object.keys(log).forEach(key => {log[key].push(p[key])})
									masses.push(p.mass)
								}
							})
							
							for (let k=0; k<log.material.length; k++){
								this.particles[this.particles.length] = new Particle(log.material[k], log.contaminant[k], log.frac[k], log.size[k], masses[k])	
							}
							
                            this.mass = masses.reduce((sum, m) => sum+m, 0)

							this.particles.forEach(p => checkPartName(p))

							let L = 0
							while (L<4 && this.particles.every((p, ind, arr) => p.material.tree[L] == arr[0].material.tree[L])){
								L ++
							}
							this.L = L
							this.HCF = this.particles[0].material.tree[L-1]

							this.contaminants = []
							this.particles.forEach(p => {
								if (p.contaminant.tree[3]){
									this.contaminants.push(p.contaminant.tree[3])
								}
							})								
							
							this.totalFrac = this.particles.reduce((sum, curr) => sum + curr.frac*curr.mass, 0) / this.particles.reduce((sum, curr) => sum + curr.mass, 0)
							
							if (this.particles.every((p,ind,arr) => p.size == arr[0].size)){this.evenSizes = true}
						}

						var bins = new Array()
						bins[0] = new Bin([stainless, stainless, plain, iron, motor, wire, cans, Cu, Al, plastic, wood])
						
						// techniques
						function shredding(i){
							bins[i].particles.forEach(particle => {
								type = particle.material.tree[1]
								if (type == "metal") {
									particle.size = Math.min(particle.size, 200)
								} else if (type == "plastic") {
									particle.size = Math.min(particle.size, 10)
								} else if (type == "wood") {
									particle.size = Math.min(particle.size, 100)
								}    
								})
                        }

						function granulating(i){
							var granules = []
							bins[i].particles.forEach(particle => {
								if (particle.contaminant == Plastic || particle.contaminant == Copper){
									var inner = new Particle(particle.material, Other, 0.1, 1, particle.mass*(100-particle.frac)/100)
									var outer = new Particle(particle.contaminant, Other, 0.1, 1, particle.mass*particle.frac/100)
									granules.push(inner, outer)
								} else {
									var g = new Particle(particle.material, particle.contaminant, particle.frac, 1, particle.mass)
									granules.push(g)
								}
							})
							bins[i] = new Bin(granules)
						}
						
                        function sort(i, conditions) {
                            var remainder = bins[i].particles
                            let j=0
                            conditions.forEach((condition, index) => {
                                var aye = []
								var nay = []
                                remainder.forEach((particle) => {
                                    if (condition(particle)){
                                        aye.push(particle)
										console.log("aye", particle.name)
                                    } else {
										nay.push(particle)
										console.log("nay", particle.name)
									}
                                })
								remainder = nay
                                bins[bins.length] = new Bin(aye)
								console.log(remainder.length)
                            })        
                            bins[bins.length] = new Bin(remainder)
                            delete bins[i]
                            bins = bins.filter(Boolean).filter(bin => bin.particles.length !== 0)
                        }

                        function magnetic(i){
                            function check(p){
								return p.material.tree[2] == "steel"
							}
                            sort(i, [check])
                        }

                        function eddy(i){
                            function check(p){
								return p.material.tree[1] == "metal"
							}
                            sort(i, [check])
                        }

                        function colour(i){ 
                            function checkColourful(p){
								return (p.outer == Plastic || p.outer == Paint)
							}
							sort(i, [checkColourful])
                        }

						function NIR(i){
							function checkPlastic(p){
								return (p.outer == Plastic)
							}
							function checkWood(p){
								return (p.outer == Wood)
							}
							function checkPaint(p){
								return (p.outer == Paint)
							}
							sort(i, [checkPaint, checkPlastic, checkWood])
						}

						function XRF(i){
							function checkMetal(p){
								return(p.material.tree[1] !== "metal")
							}
							function checkCoatings(p){
								return(p.material !== p.outer && p.outer !== Paint)
							}
							function checkStainless(p){
								return (p.material == Stainless)
							}
							function checkCastIron(p){
								return (p.material == Iron)
							}
							function checkPlain(p){
								return (p.material == Plain)
							}
							function checkAl(p){
								return (p.material == Aluminium)
							}
							function checkCu(p){
								return (p.material == Copper)
							}
							sort(i, [checkMetal, checkCoatings, checkStainless, checkCastIron, checkPlain, checkCu, checkAl])
						}

						function manual(i){
							function checkMotor(p){
								return(p.contaminant == Copper)
							}
							function checkWire(p){
								return(p.contaminant == Plastic)
							}
							function checkCans(p){
								return(p.contaminant == Tin)
							}
							function checkPlastic(p){
								return(p.material.tree[1] == "plastic")
							}
							function checkWood(p){
								return(p.material == Wood)
							}
							sort(i, [checkMotor, checkWire, checkCans, checkPlastic, checkWood])
						}
						
						function sizes(i){
							function isSmall(p){
								return p.size <= 100
							}
							sort(i, [isSmall])
						}
						
						const binCustomVar = {

						}
						
						function updateSVGs(){
							var tabs = []
							var tab = document.querySelector(".tab.bin_tab")
							bins.forEach((bin, i) => {
								tab[i] = tab.cloneNode(true)
								var svg = tab[i].querySelector("svg")
								svg.querySelector(".bin_bg").setAttribute("fill", "white")

								document.getElementById("bin_bar").appendChild(tab[i])
							})
						}

						function execute(){
							updateSVGs()
							console.log("Updated")
						}
					
					
					</script>

				</div>
				<!-- end payj - p2 -->

			</div> <!-- kanvas -->

		</div> <!-- container -->

	</body>
</html>
